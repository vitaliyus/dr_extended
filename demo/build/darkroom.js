!function(){"use strict";var element=document.createElement("div");element.id="darkroom-icons",element.style.height=0,element.style.width=0,element.style.position="absolute",element.style.visibility="hidden",element.innerHTML='<!-- inject:svg --><svg xmlns="http://www.w3.org/2000/svg"><symbol id="bold-text" viewBox="0 0 438.543 438.543"><path d="M394.005 235.541c-17.131-19.987-42.537-33.878-76.231-41.683 23.612-10.85 37.887-18.177 42.835-21.982 11.991-8.947 21.032-18.942 27.113-29.98 6.092-11.042 9.134-23.223 9.134-36.545 0-12.371-1.995-23.981-5.995-34.831-3.997-10.852-10.182-20.749-18.556-29.694-8.565-8.943-18.273-16.18-29.122-21.7-10.089-4.947-19.226-8.658-27.411-11.132-19.603-5.14-37.781-7.71-54.529-7.71h-21.128c-3.806 0-7.666-.048-11.567-.144-3.898-.09-5.944-.14-6.134-.14-.949 0-2.284.05-4.002.141-1.713.096-3.049.144-3.999.144l-12.85.287L93.074 4.283l-74.23 1.714 1.142 23.695c15.986 2.096 26.84 3.337 32.548 3.715 9.707.571 16.274 2.002 19.701 4.283 2.096 1.525 3.238 2.666 3.428 3.427 1.902 4.187 2.946 14.56 3.14 31.121.76 28.171 1.619 66.619 2.568 115.344l.571 141.896c0 24.359-.855 42.828-2.568 55.388-.761 4.569-2.762 9.422-5.997 14.562-8.756 3.614-20.461 6.567-35.117 8.85-4.375.568-10.848 1.711-19.412 3.43l-.571 26.836c45.489-1.526 71.374-2.57 77.663-3.142 40.729-2.478 69.093-3.521 85.08-3.142l56.242 1.137c22.087.76 40.929-.288 56.534-3.139 24.742-4.568 44.057-10.283 57.958-17.135 14.082-6.851 27.404-17.131 39.964-30.833 9.527-10.466 16.275-21.601 20.272-33.407 5.521-16.174 8.278-31.494 8.278-45.963.005-24.739-8.748-47.202-26.263-67.379zM170.456 33.126c14.846-2.474 27.218-3.711 37.115-3.711 32.546 0 56.82 7.139 72.805 21.413 16.169 14.272 24.263 32.071 24.263 53.387 0 30.266-8.467 51.583-25.406 63.954-16.939 12.37-42.065 18.558-75.373 18.558-12.562 0-22.935-.665-31.118-1.997-.193-6.473-.288-13.8-.288-21.986l.288-27.979c.188-29.88-.383-56.431-1.714-79.656-.382-6.28-.572-13.603-.572-21.983zm142.755 329.753c-7.043 13.702-18.657 24.458-34.83 32.265-16.181 7.806-36.74 11.703-61.671 11.703-12.182 0-25.506-3.038-39.971-9.13-2.284-5.517-3.427-9.712-3.431-12.566l-.854-77.088.288-49.392v-41.114c5.14-1.903 14.753-2.853 28.837-2.853 31.787 0 55.291 3.046 70.519 9.135 15.797 6.096 29.218 18.086 40.258 35.978 7.803 12.566 11.704 29.694 11.704 51.394-.004 21.122-3.622 38.346-10.849 51.668z"/></symbol><symbol id="brush" viewBox="0 0 36.495 36.495"><path d="M16.22 23.714l-4.85-4.848S29.192 1.011 30.622.079c0 0 2.465-.664 2.615 1.855-1.747 3.178-17.017 21.78-17.017 21.78zM4.48 36.495s-.682-5.465 4.374-5.465c5.058 0 6.185-6.133 6.185-6.133l-4.85-4.851C-.672 24.827 4.48 36.495 4.48 36.495z"/></symbol><symbol id="close" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/><path d="M0 0h24v24H0z" fill="none"/></symbol><symbol id="crop" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M17 15h2V7c0-1.1-.9-2-2-2H9v2h8v8zM7 17V1H5v4H1v2h4v10c0 1.1.9 2 2 2h10v4h2v-4h4v-2H7z"/></symbol><symbol id="done" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></symbol><symbol id="italicize-text" viewBox="0 0 438.543 438.543"><path d="M355.172.715c-6.659.478-13.134.909-19.417 1.287-28.171 1.709-48.54 2.568-61.099 2.568-6.472 0-13.422-.193-20.842-.571L163.312 0l-5.426 29.408c1.902.378 5.52.762 10.85 1.143 19.602 1.138 33.308 3.806 41.112 7.993v10.85l-2.284 14.272-6.28 38.544-4.57 17.988-8.28 44.824c0 .193-.334 1.288-1 3.287-.666 1.997-1.524 4.899-2.568 8.705a1415.803 1415.803 0 0 0-3.571 13.278c-1.335 5.042-2.856 11.421-4.57 19.13a631.423 631.423 0 0 0-4.853 24.124l-3.428 18.274-15.986 76.517-7.71 39.677c-2.285 12.189-6.184 21.802-11.704 28.838-7.614 3.81-18.654 7.519-33.12 11.14a12036.646 12036.646 0 0 1-21.982 5.708l-4.853 24.273c4.565-.38 13.891-1.235 27.978-2.573 25.315-2.283 41.874-3.33 49.676-3.139l56.532.568c23.979 2.478 37.777 4.093 41.391 4.859 3.617.568 6.283.855 7.994.855 3.429 0 7.423-.191 11.991-.571.951-.188 3.142-.284 6.567-.284.38-1.902 1.235-5.808 2.569-11.711a99.327 99.327 0 0 0 1.999-16.562 695.404 695.404 0 0 0-18.85-2.848c-10.461-1.143-21.792-3.145-33.975-5.996-.564-3.805-.661-6.375-.281-7.71l3.43-12.847 12.278-67.091 10.849-45.111 17.418-88.793c4.183-20.367 10.466-49.484 18.847-87.366.763-7.232 1.995-15.037 3.713-23.413 2.282-10.848 4.571-19.221 6.851-25.125 7.043-2.853 16.659-5.802 28.836-8.848 10.286-2.281 20.655-5.232 31.121-8.848a486.69 486.69 0 0 0 3.716-14.561A104.328 104.328 0 0 0 365.45.01c-.189-.007-3.618.23-10.278.705z"/></symbol><symbol id="redo" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M18.4 10.6C16.55 8.99 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16a8.002 8.002 0 0 1 7.6-5.5c1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z"/></symbol><symbol id="rotate-left" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M7.11 8.53L5.7 7.11C4.8 8.27 4.24 9.61 4.07 11h2.02c.14-.87.49-1.72 1.02-2.47zM6.09 13H4.07c.17 1.39.72 2.73 1.62 3.89l1.41-1.42c-.52-.75-.87-1.59-1.01-2.47zm1.01 5.32c1.16.9 2.51 1.44 3.9 1.61V17.9c-.87-.15-1.71-.49-2.46-1.03L7.1 18.32zM13 4.07V1L8.45 5.55 13 10V6.09c2.84.48 5 2.94 5 5.91s-2.16 5.43-5 5.91v2.02c3.95-.49 7-3.85 7-7.93s-3.05-7.44-7-7.93z"/></symbol><symbol id="rotate-right" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M15.55 5.55L11 1v3.07C7.06 4.56 4 7.92 4 12s3.05 7.44 7 7.93v-2.02c-2.84-.48-5-2.94-5-5.91s2.16-5.43 5-5.91V10l4.55-4.45zM19.93 11a7.906 7.906 0 0 0-1.62-3.89l-1.42 1.42c.54.75.88 1.6 1.02 2.47h2.02zM13 17.9v2.02c1.39-.17 2.74-.71 3.9-1.61l-1.44-1.44c-.75.54-1.59.89-2.46 1.03zm3.89-2.42l1.42 1.41c.9-1.16 1.45-2.5 1.62-3.89h-2.02c-.14.87-.48 1.72-1.02 2.48z"/></symbol><symbol id="save" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></symbol><symbol id="square" viewBox="0 0 491.858 491.858"><path d="M491.858 475.862c0 8.833-7.162 15.996-15.996 15.996H15.996C7.16 491.858 0 484.696 0 475.862V15.996C0 7.16 7.16 0 15.996 0h459.866c8.834 0 15.996 7.16 15.996 15.996v459.866z"/></symbol><symbol id="text" viewBox="0 0 475.082 475.082"><path d="M473.371 433.11c-10.657-3.997-20.458-6.563-29.407-7.706-8.945-.767-15.516-2.95-19.701-6.567-2.475-1.529-5.808-6.95-9.996-16.279-7.806-15.604-13.989-29.786-18.555-42.537-7.427-20.181-13.617-35.789-18.565-46.829-10.845-25.311-19.982-47.678-27.401-67.092-4.001-10.466-15.797-38.731-35.405-84.796L255.813 24.265l-3.142-5.996h-36.543l-79.94 206.704-67.665 175.874c-5.33 9.896-9.9 16.372-13.706 19.417-3.996 2.848-14.466 5.805-31.405 8.843-11.042 2.102-18.654 3.812-22.841 5.141L0 456.812h5.996c16.37 0 32.264-1.334 47.679-3.997l13.706-2.279c53.868 3.806 87.082 5.708 99.642 5.708.381-1.902.571-4.476.571-7.706 0-5.715-.094-11.231-.287-16.563-3.996-.568-7.851-1.143-11.561-1.711-3.711-.575-6.567-1.047-8.565-1.431-1.997-.373-3.284-.568-3.855-.568-14.657-2.094-24.46-5.14-29.407-9.134-3.236-2.282-4.854-6.375-4.854-12.278 0-3.806 2.19-11.796 6.567-23.982 14.277-39.776 24.172-65.856 29.692-78.224l128.483.568 26.269 65.096 13.411 32.541c1.144 3.241 1.711 6.283 1.711 9.138s-1.14 5.428-3.426 7.707c-2.285 1.905-8.753 4.093-19.417 6.563l-37.404 7.994c-.763 6.283-1.136 13.702-1.136 22.271l16.56-.575 57.103-3.138c10.656-.38 23.51-.575 38.547-.575 18.264 0 36.251.763 53.957 2.282 21.313 1.523 39.588 2.283 54.819 2.283.192-2.283.281-4.754.281-7.423 0-3.422-.569-8.842-1.711-16.269zM251.245 270.941c-2.666 0-7.662-.052-14.989-.144-7.327-.089-18.649-.233-33.973-.425-15.321-.195-29.93-.383-43.824-.574l48.535-128.477c7.424 15.037 16.178 35.117 26.264 60.242 11.425 27.79 20.179 50.727 26.273 68.809l-8.286.569z"/></symbol><symbol id="underline-text" viewBox="0 0 438.543 438.543"><path d="M13.706 27.131c23.223.572 37.212 4.286 41.967 11.122 3.234 4.764 4.854 25.031 4.854 60.813v95.076c0 29.886 1.52 52.438 4.565 67.666 4.192 22.648 12.09 41.21 23.7 55.672 11.416 14.277 28.455 25.893 51.103 34.834 22.27 8.754 49.298 13.131 81.082 13.131 27.787 0 52.058-3.135 72.81-9.417 20.361-6.092 37.685-14.565 51.955-25.413 14.093-11.037 24.749-22.744 31.977-35.118 4.948-8.754 8.856-20.369 11.711-34.824 3.997-20.745 5.428-49.687 4.284-86.8-2.662-71.761-4.757-109.446-6.283-113.063 0-2.091-.144-5.042-.424-8.848-.288-3.809-.432-6.374-.432-7.708 0-4.949 1.431-8.854 4.285-11.706 1.149-1.141 8.661-2.762 22.555-4.856 7.427-.19 15.424-1.431 23.986-3.711.767-4.567 1.14-7.517 1.14-8.852 0-2.474-.564-7.329-1.708-14.558L431.693 0c-22.843 2.475-41.494 3.424-55.963 2.854L317.205 0h-23.982l-.575 24.556 4 .854 28.552-.57c8.179-.19 15.509 3.047 21.98 9.71 3.613 3.997 5.903 12.369 6.851 25.122l1.137 16.849c1.149 16.368 2.43 31.545 3.86 45.533 1.431 13.99 2.478 25.649 3.142 34.973.664 9.329.999 21.51.999 36.547 0 29.694-1.999 51.48-5.996 65.374-3.23 11.04-8.281 21.895-15.126 32.552-3.244 5.331-9.428 11.42-18.568 18.277-8.179 6.276-17.597 11.129-28.26 14.555-16.563 5.332-34.738 7.994-54.529 7.994-16.946 0-33.783-4.47-50.535-13.422-11.61-6.276-20.745-15.03-27.407-26.262-8.563-14.842-13.418-34.074-14.561-57.677l-3.997-79.938-.291-65.374c0-1.138-.049-3.566-.144-7.277a369.601 369.601 0 0 1-.144-9.276c0-22.459 1.237-35.019 3.71-37.685 3.621-4.76 11.137-7.139 22.557-7.139 12.185 0 23.984-.855 35.404-2.568v-2.57l-.57-18.271.283-3.999c-5.708.38-13.891.572-24.551.572-5.708.19-19.605.666-41.684 1.427-15.612.572-31.599.854-47.967.854-6.473 0-22.27-.662-47.395-1.997C33.501.964 22.841.585 11.421.585 6.281.585 2.474.677.002.869l.857 25.126c1.521.376 5.804.758 12.847 1.136zM429.4 402.001H9.14c-2.664 0-4.854.855-6.567 2.57-1.715 1.715-2.568 3.901-2.568 6.567v18.271c0 2.666.857 4.856 2.568 6.567 1.713 1.715 3.899 2.566 6.567 2.566H429.4c2.669 0 4.859-.852 6.57-2.566 1.711-1.711 2.563-3.901 2.563-6.567v-18.271c0-2.666-.853-4.853-2.563-6.567s-3.901-2.57-6.57-2.57z"/></symbol><symbol id="undo" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></symbol></svg><!-- endinject -->',document.body.appendChild(element)}(),function(){"use strict";function Darkroom(element,options,plugins){return this.constructor(element,options,plugins)}window.Darkroom=Darkroom,Darkroom.plugins=[],Darkroom.prototype={containerElement:null,canvas:null,image:null,sourceCanvas:null,sourceImage:null,originalImageElement:null,transformations:[],defaults:{minWidth:null,minHeight:null,maxWidth:null,maxHeight:null,ratio:null,backgroundColor:"#fff",plugins:{},initialize:function(){}},plugins:{},options:{},count:0,constructor:function(element,options,plugins){if(this.options=Darkroom.Utils.extend(options,this.defaults),"string"==typeof element&&(element=document.querySelector(element)),null!==element){var image=new Image;image.onload=function(){this._initializeDOM(element),this._initializeImage(),this._initializePlugins(Darkroom.plugins),this.refresh(function(){this.options.initialize.bind(this).call()}.bind(this))}.bind(this),image.src=element.src}},selfDestroy:function(callback){var container=this.containerElement,image=new Image;image.onload=function(){container.parentNode.replaceChild(image,container),callback?callback(image):null},image.src=this.sourceImage.toDataURL()},addEventListener:function(eventName,callback){var el=this.canvas.getElement();el.addEventListener?el.addEventListener(eventName,callback):el.attachEvent&&el.attachEvent("on"+eventName,callback)},dispatchEvent:function(eventName,e){var event=document.createEvent("Event");event.initEvent(eventName,!0,!0),this.canvas.getElement().dispatchEvent(event,e)},refresh:function(next){var clone=new Image;clone.onload=function(){this._replaceCurrentImage(new fabric.Image(clone)),next&&next()}.bind(this),clone.src=this.sourceImage.toDataURL()},_replaceCurrentImage:function(newImage){this.image&&this.image.remove(),this.image=newImage,this.image.selectable=!1;var viewport=Darkroom.Utils.computeImageViewPort(this.image),canvasWidth=viewport.width,canvasHeight=viewport.height;if(null!==this.options.ratio){var canvasRatio=+this.options.ratio,currentRatio=canvasWidth/canvasHeight;currentRatio>canvasRatio?canvasHeight=canvasWidth/canvasRatio:canvasRatio>currentRatio&&(canvasWidth=canvasHeight*canvasRatio)}var scaleMin=1,scaleMax=1,scaleX=1,scaleY=1;null!==this.options.maxWidth&&this.options.maxWidth<canvasWidth&&(scaleX=this.options.maxWidth/canvasWidth),null!==this.options.maxHeight&&this.options.maxHeight<canvasHeight&&(scaleY=this.options.maxHeight/canvasHeight),scaleMin=Math.min(scaleX,scaleY),scaleX=1,scaleY=1,null!==this.options.minWidth&&this.options.minWidth>canvasWidth&&(scaleX=this.options.minWidth/canvasWidth),null!==this.options.minHeight&&this.options.minHeight>canvasHeight&&(scaleY=this.options.minHeight/canvasHeight),scaleMax=Math.max(scaleX,scaleY);var scale=scaleMax*scaleMin;canvasWidth*=scale,canvasHeight*=scale,this.image.setScaleX(1*scale),this.image.setScaleY(1*scale),this.image.applyFilters(this.canvas.renderAll.bind(this.canvas)),this.canvas.add(this.image),this.canvas.setWidth(canvasWidth),this.canvas.setHeight(canvasHeight),this.canvas.centerObject(this.image),this.image.setCoords()},applyTransformation:function(transformation){this.transformations.push(transformation),transformation.applyTransformation(this.sourceCanvas,this.sourceImage,this._postTransformation.bind(this))},_postTransformation:function(newImage){newImage&&(this.sourceImage=newImage),this.refresh(function(){this.dispatchEvent("core:transformation")}.bind(this))},reinitializeImage:function(){this.sourceImage.remove(),this._initializeImage(),this._popTransformation(this.transformations.slice())},_popTransformation:function(transformations){if(0===transformations.length)return this.dispatchEvent("core:reinitialized"),void this.refresh();var transformation=transformations.shift(),next=function(newImage){newImage&&(this.sourceImage=newImage),this._popTransformation(transformations)};transformation.applyTransformation(this.sourceCanvas,this.sourceImage,next.bind(this))},_initializeDOM:function(imageElement){var mainContainerElement=document.createElement("div");mainContainerElement.className="darkroom-container";var toolbarElement=document.createElement("div");toolbarElement.className="darkroom-toolbar",mainContainerElement.appendChild(toolbarElement);var canvasContainerElement=document.createElement("div");canvasContainerElement.className="darkroom-image-container";var canvasElement=document.createElement("canvas");canvasContainerElement.appendChild(canvasElement),mainContainerElement.appendChild(canvasContainerElement);var sourceCanvasContainerElement=document.createElement("div");sourceCanvasContainerElement.className="darkroom-source-container",sourceCanvasContainerElement.style.display="none";var sourceCanvasElement=document.createElement("canvas");sourceCanvasContainerElement.appendChild(sourceCanvasElement),mainContainerElement.appendChild(sourceCanvasContainerElement),imageElement.parentNode.replaceChild(mainContainerElement,imageElement),imageElement.style.display="none",mainContainerElement.appendChild(imageElement),this.containerElement=mainContainerElement,this.originalImageElement=imageElement,this.toolbar=new Darkroom.UI.Toolbar(toolbarElement),this.canvas=new fabric.Canvas(canvasElement,{selection:!1,backgroundColor:this.options.backgroundColor}),this.sourceCanvas=new fabric.Canvas(sourceCanvasElement,{selection:!1,backgroundColor:this.options.backgroundColor})},_initializeImage:function(){this.sourceImage=new fabric.Image(this.originalImageElement,{selectable:!1,evented:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,hasControls:!1,hasBorders:!1}),this.sourceCanvas.add(this.sourceImage);var viewport=Darkroom.Utils.computeImageViewPort(this.sourceImage),canvasWidth=viewport.width,canvasHeight=viewport.height;this.sourceCanvas.setWidth(canvasWidth),this.sourceCanvas.setHeight(canvasHeight),this.sourceCanvas.centerObject(this.sourceImage),this.sourceImage.setCoords()},_initializePlugins:function(plugins){for(var name in plugins){var plugin=plugins[name],options=this.options.plugins[name];options!==!1&&plugins.hasOwnProperty(name)&&(this.plugins[name]=new plugin(this,options))}},test:function(src){if(1===this.count){console.log("Test execute");var snapshot=new Image;snapshot.onload=function(){var imgInstance=new fabric.Image(this,{selectable:!1,evented:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,hasControls:!1,hasBorders:!1}),myCanvas=new fabric.Canvas("vitaliy-canvas",{height:600,width:800});myCanvas.add(imgInstance),myCanvas.setWidth(800),myCanvas.setHeight(600),myCanvas.add(imgInstance)},snapshot.src=src}this.count++}}}(),function(){"use strict";function Plugin(darkroom,options){this.darkroom=darkroom,this.options=Darkroom.Utils.extend(options,this.defaults),this.initialize()}Darkroom.Plugin=Plugin,Plugin.prototype={defaults:{},initialize:function(){}},Plugin.extend=function(protoProps){var child,parent=this;child=protoProps&&protoProps.hasOwnProperty("constructor")?protoProps.constructor:function(){return parent.apply(this,arguments)},Darkroom.Utils.extend(child,parent);var Surrogate=function(){this.constructor=child};return Surrogate.prototype=parent.prototype,child.prototype=new Surrogate,protoProps&&Darkroom.Utils.extend(child.prototype,protoProps),child.__super__=parent.prototype,child}}(),function(){"use strict";function Transformation(options){this.options=options}Darkroom.Transformation=Transformation,Transformation.prototype={applyTransformation:function(image){}},Transformation.extend=function(protoProps){var child,parent=this;child=protoProps&&protoProps.hasOwnProperty("constructor")?protoProps.constructor:function(){return parent.apply(this,arguments)},Darkroom.Utils.extend(child,parent);var Surrogate=function(){this.constructor=child};return Surrogate.prototype=parent.prototype,child.prototype=new Surrogate,protoProps&&Darkroom.Utils.extend(child.prototype,protoProps),child.__super__=parent.prototype,child}}(),function(){"use strict";function Toolbar(element){this.element=element}function ButtonGroup(element){this.element=element}function Button(element){this.element=element}Darkroom.UI={Toolbar:Toolbar,ButtonGroup:ButtonGroup,Button:Button},Toolbar.prototype={createButtonGroup:function(options){var buttonGroup=document.createElement("div");return buttonGroup.className="darkroom-button-group",this.element.appendChild(buttonGroup),new ButtonGroup(buttonGroup)}},ButtonGroup.prototype={createButton:function(options){var defaults={image:"help",type:"default",group:"default",hide:!1,disabled:!1};options=Darkroom.Utils.extend(options,defaults);var buttonElement=document.createElement("button");buttonElement.type="button",buttonElement.className="darkroom-button darkroom-button-"+options.type,buttonElement.innerHTML='<svg class="darkroom-icon"><use xlink:href="#'+options.image+'" /></svg>',this.element.appendChild(buttonElement);var button=new Button(buttonElement);return button.hide(options.hide),button.disable(options.disabled),button}},Button.prototype={addEventListener:function(eventName,listener){this.element.addEventListener?this.element.addEventListener(eventName,listener):this.element.attachEvent&&this.element.attachEvent("on"+eventName,listener)},removeEventListener:function(eventName,listener){this.element.removeEventListener&&this.element.removeEventListener(eventName,listener)},active:function(value){value?this.element.classList.add("darkroom-button-active"):this.element.classList.remove("darkroom-button-active")},hide:function(value){value?this.element.classList.add("darkroom-button-hidden"):this.element.classList.remove("darkroom-button-hidden")},disable:function(value){this.element.disabled=!!value}}}(),function(){"use strict";function extend(b,a){var prop;if(void 0===b)return a;for(prop in a)a.hasOwnProperty(prop)&&b.hasOwnProperty(prop)===!1&&(b[prop]=a[prop]);return b}function computeImageViewPort(image){return{height:Math.abs(image.getWidth()*Math.sin(image.getAngle()*Math.PI/180))+Math.abs(image.getHeight()*Math.cos(image.getAngle()*Math.PI/180)),width:Math.abs(image.getHeight()*Math.sin(image.getAngle()*Math.PI/180))+Math.abs(image.getWidth()*Math.cos(image.getAngle()*Math.PI/180))}}Darkroom.Utils={extend:extend,computeImageViewPort:computeImageViewPort}}(),function(window,document,Darkroom,fabric){"use strict";Darkroom.plugins.history=Darkroom.Plugin.extend({undoTransformations:[],initialize:function(){this._initButtons(),this.darkroom.addEventListener("core:transformation",this._onTranformationApplied.bind(this))},undo:function(){if(0!==this.darkroom.transformations.length){var lastTransformation=this.darkroom.transformations.pop();this.undoTransformations.unshift(lastTransformation),this.darkroom.reinitializeImage(),this._updateButtons()}},redo:function(){if(0!==this.undoTransformations.length){var cancelTransformation=this.undoTransformations.shift();this.darkroom.transformations.push(cancelTransformation),this.darkroom.reinitializeImage(),this._updateButtons()}},_initButtons:function(){var buttonGroup=this.darkroom.toolbar.createButtonGroup();return this.backButton=buttonGroup.createButton({image:"undo",disabled:!0}),this.forwardButton=buttonGroup.createButton({image:"redo",disabled:!0}),this.backButton.addEventListener("click",this.undo.bind(this)),this.forwardButton.addEventListener("click",this.redo.bind(this)),this},_updateButtons:function(){this.backButton.disable(0===this.darkroom.transformations.length),this.forwardButton.disable(0===this.undoTransformations.length)},_onTranformationApplied:function(){this.undoTransformations=[],this._updateButtons()}})}(window,document,Darkroom,fabric),function(){"use strict";var Rotation=Darkroom.Transformation.extend({applyTransformation:function(canvas,image,next){var angle=(image.getAngle()+this.options.angle)%360;image.rotate(angle);var width,height;height=Math.abs(image.getWidth()*Math.sin(angle*Math.PI/180))+Math.abs(image.getHeight()*Math.cos(angle*Math.PI/180)),width=Math.abs(image.getHeight()*Math.sin(angle*Math.PI/180))+Math.abs(image.getWidth()*Math.cos(angle*Math.PI/180)),canvas.setWidth(width),canvas.setHeight(height),canvas.centerObject(image),image.setCoords(),canvas.renderAll(),next()}});Darkroom.plugins.rotate=Darkroom.Plugin.extend({initialize:function(){var buttonGroup=this.darkroom.toolbar.createButtonGroup(),leftButton=buttonGroup.createButton({image:"rotate-left"}),rightButton=buttonGroup.createButton({image:"rotate-right"});leftButton.addEventListener("click",this.rotateLeft.bind(this)),rightButton.addEventListener("click",this.rotateRight.bind(this))},rotateLeft:function(){this.rotate(-90)},rotateRight:function(){this.rotate(90)},rotate:function(angle){this.darkroom.applyTransformation(new Rotation({angle:angle}))}})}(),function(){"use strict";var Crop=Darkroom.Transformation.extend({applyTransformation:function(canvas,image,next){var snapshot=new Image;snapshot.onload=function(){if(!(1>height||1>width)){var imgInstance=new fabric.Image(this,{selectable:!1,evented:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,hasControls:!1,hasBorders:!1}),width=this.width,height=this.height;canvas.setWidth(width),canvas.setHeight(height),image.remove(),canvas.add(imgInstance),next(imgInstance)}};var viewport=Darkroom.Utils.computeImageViewPort(image),imageWidth=viewport.width,imageHeight=viewport.height,left=this.options.left*imageWidth,top=this.options.top*imageHeight,width=Math.min(this.options.width*imageWidth,imageWidth-left),height=Math.min(this.options.height*imageHeight,imageHeight-top);snapshot.src=canvas.toDataURL({left:left,top:top,width:width,height:height})}}),CropZone=fabric.util.createClass(fabric.Rect,{_render:function(ctx){this.callSuper("_render",ctx);var dashWidth=(ctx.canvas,7),flipX=this.flipX?-1:1,flipY=this.flipY?-1:1,scaleX=flipX/this.scaleX,scaleY=flipY/this.scaleY;ctx.scale(scaleX,scaleY),ctx.fillStyle="rgba(0, 0, 0, 0.5)",this._renderOverlay(ctx),void 0!==ctx.setLineDash?ctx.setLineDash([dashWidth,dashWidth]):void 0!==ctx.mozDash&&(ctx.mozDash=[dashWidth,dashWidth]),ctx.strokeStyle="rgba(0, 0, 0, 0.2)",this._renderBorders(ctx),this._renderGrid(ctx),ctx.lineDashOffset=dashWidth,ctx.strokeStyle="rgba(255, 255, 255, 0.4)",this._renderBorders(ctx),this._renderGrid(ctx),ctx.scale(1/scaleX,1/scaleY)},_renderOverlay:function(ctx){var canvas=ctx.canvas,x0=Math.ceil(-this.getWidth()/2-this.getLeft()),x1=Math.ceil(-this.getWidth()/2),x2=Math.ceil(this.getWidth()/2),x3=Math.ceil(this.getWidth()/2+(canvas.width-this.getWidth()-this.getLeft())),y0=Math.ceil(-this.getHeight()/2-this.getTop()),y1=Math.ceil(-this.getHeight()/2),y2=Math.ceil(this.getHeight()/2),y3=Math.ceil(this.getHeight()/2+(canvas.height-this.getHeight()-this.getTop()));ctx.beginPath(),ctx.moveTo(x0-1,y0-1),ctx.lineTo(x3+1,y0-1),ctx.lineTo(x3+1,y3+1),ctx.lineTo(x0-1,y3-1),ctx.lineTo(x0-1,y0-1),ctx.closePath(),ctx.moveTo(x1,y1),ctx.lineTo(x1,y2),ctx.lineTo(x2,y2),ctx.lineTo(x2,y1),ctx.lineTo(x1,y1),ctx.closePath(),ctx.fill()},_renderBorders:function(ctx){ctx.beginPath(),ctx.moveTo(-this.getWidth()/2,-this.getHeight()/2),ctx.lineTo(this.getWidth()/2,-this.getHeight()/2),ctx.lineTo(this.getWidth()/2,this.getHeight()/2),ctx.lineTo(-this.getWidth()/2,this.getHeight()/2),ctx.lineTo(-this.getWidth()/2,-this.getHeight()/2),ctx.stroke()},_renderGrid:function(ctx){ctx.beginPath(),ctx.moveTo(-this.getWidth()/2+1/3*this.getWidth(),-this.getHeight()/2),ctx.lineTo(-this.getWidth()/2+1/3*this.getWidth(),this.getHeight()/2),ctx.stroke(),ctx.beginPath(),ctx.moveTo(-this.getWidth()/2+2/3*this.getWidth(),-this.getHeight()/2),ctx.lineTo(-this.getWidth()/2+2/3*this.getWidth(),this.getHeight()/2),ctx.stroke(),ctx.beginPath(),ctx.moveTo(-this.getWidth()/2,-this.getHeight()/2+1/3*this.getHeight()),ctx.lineTo(this.getWidth()/2,-this.getHeight()/2+1/3*this.getHeight()),ctx.stroke(),ctx.beginPath(),ctx.moveTo(-this.getWidth()/2,-this.getHeight()/2+2/3*this.getHeight()),ctx.lineTo(this.getWidth()/2,-this.getHeight()/2+2/3*this.getHeight()),ctx.stroke()}}),itsMe=!1;Darkroom.plugins.crop=Darkroom.Plugin.extend({startX:null,startY:null,isKeyCroping:!1,isKeyLeft:!1,isKeyUp:!1,defaults:{minHeight:1,minWidth:1,ratio:null,quickCropKey:!1},initialize:function(){var buttonGroup=this.darkroom.toolbar.createButtonGroup();this.cropButton=buttonGroup.createButton({image:"crop"}),this.okButton=buttonGroup.createButton({image:"done",type:"success",hide:!0}),this.cancelButton=buttonGroup.createButton({image:"close",type:"danger",hide:!0}),this.cropButton.addEventListener("click",this.toggleCrop.bind(this)),this.okButton.addEventListener("click",this.cropCurrentZone.bind(this)),this.cancelButton.addEventListener("click",this.releaseFocus.bind(this)),this.darkroom.canvas.on("mouse:down",this.onMouseDown.bind(this)),this.darkroom.canvas.on("mouse:move",this.onMouseMove.bind(this)),this.darkroom.canvas.on("mouse:up",this.onMouseUp.bind(this)),this.darkroom.canvas.on("object:moving",this.onObjectMoving.bind(this)),this.darkroom.canvas.on("object:scaling",this.onObjectScaling.bind(this)),fabric.util.addListener(fabric.document,"keydown",this.onKeyDown.bind(this)),fabric.util.addListener(fabric.document,"keyup",this.onKeyUp.bind(this)),this.darkroom.addEventListener("core:transformation",this.releaseFocus.bind(this)),this.darkroom.addEventListener("button-group:activate",this.activateSomeToolbarButton.bind(this)),this.darkroom.addEventListener("button-group:save",this.cropCurrentZone.bind(this))},activateSomeToolbarButton:function(){itsMe?itsMe=!1:this.releaseFocus()},onObjectMoving:function(event){if(this.hasFocus()){var currentObject=event.target;if(currentObject===this.cropZone){var canvas=this.darkroom.canvas,x=currentObject.getLeft(),y=currentObject.getTop(),w=currentObject.getWidth(),h=currentObject.getHeight(),maxX=canvas.getWidth()-w,maxY=canvas.getHeight()-h;0>x&&currentObject.set("left",0),0>y&&currentObject.set("top",0),x>maxX&&currentObject.set("left",maxX),y>maxY&&currentObject.set("top",maxY),this.darkroom.dispatchEvent("crop:update")}}},onObjectScaling:function(event){if(this.hasFocus()){var preventScaling=!1,currentObject=event.target;if(currentObject===this.cropZone){var canvas=this.darkroom.canvas,pointer=canvas.getPointer(event.e),minX=(pointer.x,pointer.y,currentObject.getLeft()),minY=currentObject.getTop(),maxX=currentObject.getLeft()+currentObject.getWidth(),maxY=currentObject.getTop()+currentObject.getHeight();if(null!==this.options.ratio&&(0>minX||maxX>canvas.getWidth()||0>minY||maxY>canvas.getHeight())&&(preventScaling=!0),0>minX||maxX>canvas.getWidth()||preventScaling){var lastScaleX=this.lastScaleX||1;currentObject.setScaleX(lastScaleX)}if(0>minX&&currentObject.setLeft(0),0>minY||maxY>canvas.getHeight()||preventScaling){var lastScaleY=this.lastScaleY||1;currentObject.setScaleY(lastScaleY)}0>minY&&currentObject.setTop(0),currentObject.getWidth()<this.options.minWidth&&currentObject.scaleToWidth(this.options.minWidth),currentObject.getHeight()<this.options.minHeight&&currentObject.scaleToHeight(this.options.minHeight),this.lastScaleX=currentObject.getScaleX(),this.lastScaleY=currentObject.getScaleY(),this.darkroom.dispatchEvent("crop:update")}}},onMouseDown:function(event){if(this.hasFocus()){var canvas=this.darkroom.canvas;canvas.calcOffset();var pointer=canvas.getPointer(event.e),x=pointer.x,y=pointer.y,point=new fabric.Point(x,y),activeObject=canvas.getActiveObject();activeObject===this.cropZone||this.cropZone.containsPoint(point)||(canvas.discardActiveObject(),this.cropZone.setWidth(0),this.cropZone.setHeight(0),this.cropZone.setScaleX(1),this.cropZone.setScaleY(1),this.startX=x,this.startY=y)}},onMouseMove:function(event){if(this.isKeyCroping)return this.onMouseMoveKeyCrop(event);if(null!==this.startX&&null!==this.startY){var canvas=this.darkroom.canvas,pointer=canvas.getPointer(event.e),x=pointer.x,y=pointer.y;this._renderCropZone(this.startX,this.startY,x,y)}},onMouseMoveKeyCrop:function(event){var canvas=this.darkroom.canvas,zone=this.cropZone,pointer=canvas.getPointer(event.e),x=pointer.x,y=pointer.y;zone.left&&zone.top||(zone.setTop(y),zone.setLeft(x)),this.isKeyLeft=x<zone.left+zone.width/2,this.isKeyUp=y<zone.top+zone.height/2,this._renderCropZone(Math.min(zone.left,x),Math.min(zone.top,y),Math.max(zone.left+zone.width,x),Math.max(zone.top+zone.height,y))},onMouseUp:function(event){if(null!==this.startX&&null!==this.startY){var canvas=this.darkroom.canvas;this.cropZone.setCoords(),canvas.setActiveObject(this.cropZone),canvas.calcOffset(),this.startX=null,this.startY=null}},onKeyDown:function(event){!1===this.options.quickCropKey||event.keyCode!==this.options.quickCropKey||this.isKeyCroping||(this.isKeyCroping=!0,this.darkroom.canvas.discardActiveObject(),this.cropZone.setWidth(0),this.cropZone.setHeight(0),this.cropZone.setScaleX(1),this.cropZone.setScaleY(1),this.cropZone.setTop(0),this.cropZone.setLeft(0))},onKeyUp:function(event){!1!==this.options.quickCropKey&&event.keyCode===this.options.quickCropKey&&this.isKeyCroping&&(this.isKeyCroping=!1,this.startX=1,this.startY=1,this.onMouseUp())},selectZone:function(x,y,width,height,forceDimension){this.hasFocus()||this.requireFocus(),forceDimension?this.cropZone.set({left:x,top:y,width:width,height:height}):this._renderCropZone(x,y,x+width,y+height);var canvas=this.darkroom.canvas;canvas.bringToFront(this.cropZone),this.cropZone.setCoords(),canvas.setActiveObject(this.cropZone),canvas.calcOffset(),this.darkroom.dispatchEvent("crop:update")},toggleCrop:function(){this.hasFocus()?this.releaseFocus():this.requireFocus()},cropCurrentZone:function(){if(this.hasFocus()&&!(this.cropZone.width<1&&this.cropZone.height<1)){var image=this.darkroom.image,top=this.cropZone.getTop()-image.getTop(),left=this.cropZone.getLeft()-image.getLeft(),width=this.cropZone.getWidth(),height=this.cropZone.getHeight();
0>top&&(height+=top,top=0),0>left&&(width+=left,left=0),this.darkroom.applyTransformation(new Crop({top:top/image.getHeight(),left:left/image.getWidth(),width:width/image.getWidth(),height:height/image.getHeight()}))}},hasFocus:function(){return void 0!==this.cropZone},requireFocus:function(){this.cropZone=new CropZone({fill:"transparent",hasBorders:!1,originX:"left",originY:"top",cornerColor:"#444",cornerSize:8,transparentCorners:!1,lockRotation:!0,hasRotatingPoint:!1}),null!==this.options.ratio&&this.cropZone.set("lockUniScaling",!0),this.darkroom.canvas.add(this.cropZone),this.darkroom.canvas.defaultCursor="crosshair",this.cropButton.active(!0),this.okButton.hide(!1),this.cancelButton.hide(!1),itsMe=!0,this.darkroom.dispatchEvent("button-group:activate")},releaseFocus:function(){void 0!==this.cropZone&&(this.cropZone.remove(),this.cropZone=void 0,this.cropButton.active(!1),this.okButton.hide(!0),this.cancelButton.hide(!0),this.darkroom.canvas.defaultCursor="default",this.darkroom.dispatchEvent("crop:update"))},_renderCropZone:function(fromX,fromY,toX,toY){var canvas=this.darkroom.canvas,isRight=toX>fromX,isLeft=!isRight,isDown=toY>fromY,isUp=!isDown,minWidth=Math.min(+this.options.minWidth,canvas.getWidth()),minHeight=Math.min(+this.options.minHeight,canvas.getHeight()),leftX=Math.min(fromX,toX),rightX=Math.max(fromX,toX),topY=Math.min(fromY,toY),bottomY=Math.max(fromY,toY);leftX=Math.max(0,leftX),rightX=Math.min(canvas.getWidth(),rightX),topY=Math.max(0,topY),bottomY=Math.min(canvas.getHeight(),bottomY),minWidth>rightX-leftX&&(isRight?rightX=leftX+minWidth:leftX=rightX-minWidth),minHeight>bottomY-topY&&(isDown?bottomY=topY+minHeight:topY=bottomY-minHeight),0>leftX&&(rightX+=Math.abs(leftX),leftX=0),rightX>canvas.getWidth()&&(leftX-=rightX-canvas.getWidth(),rightX=canvas.getWidth()),0>topY&&(bottomY+=Math.abs(topY),topY=0),bottomY>canvas.getHeight()&&(topY-=bottomY-canvas.getHeight(),bottomY=canvas.getHeight());var width=rightX-leftX,height=bottomY-topY,currentRatio=width/height;if(this.options.ratio&&+this.options.ratio!==currentRatio){var ratio=+this.options.ratio;if(this.isKeyCroping&&(isLeft=this.isKeyLeft,isUp=this.isKeyUp),ratio>currentRatio){var newWidth=height*ratio;isLeft&&(leftX-=newWidth-width),width=newWidth}else if(currentRatio>ratio){var newHeight=height/(ratio*height/width);isUp&&(topY-=newHeight-height),height=newHeight}if(0>leftX&&(leftX=0),0>topY&&(topY=0),leftX+width>canvas.getWidth()){var newWidth=canvas.getWidth()-leftX;height=newWidth*height/width,width=newWidth,isUp&&(topY=fromY-height)}if(topY+height>canvas.getHeight()){var newHeight=canvas.getHeight()-topY;width=width*newHeight/height,height=newHeight,isLeft&&(leftX=fromX-width)}}this.cropZone.left=leftX,this.cropZone.top=topY,this.cropZone.width=width,this.cropZone.height=height,this.darkroom.canvas.bringToFront(this.cropZone),this.darkroom.dispatchEvent("crop:update")}})}(),function(){"use strict";Darkroom.plugins.save=Darkroom.Plugin.extend({defaults:{callback:function(){var self=this;this.darkroom.selfDestroy(function(img){var link=document.createElement("a");link.setAttribute("href",img.src),link.setAttribute("download","download"),link.click(),self.options.userCallback&&self.options.userCallback()})},userCallback:null},initialize:function(){var buttonGroup=this.darkroom.toolbar.createButtonGroup();this.destroyButton=buttonGroup.createButton({image:"save"}),this.destroyButton.addEventListener("click",this.saving.bind(this))},saving:function(){this.darkroom.dispatchEvent("button-group:save"),setTimeout(this.options.callback.bind(this),1e3)}})}(),function(){"use strict";function isDescendant(parent,child){for(var node=child.parentNode;null!=node;){if(node==parent)return!0;node=node.parentNode}return!1}function getOffset(elem){return elem.getBoundingClientRect?getOffsetRect(elem):getOffsetSum(elem)}function getOffsetSum(elem){for(var top=0,left=0;elem;)top+=parseInt(elem.offsetTop),left+=parseInt(elem.offsetLeft),elem=elem.offsetParent;return{top:top,left:left}}function getOffsetRect(elem){var box=elem.getBoundingClientRect(),body=document.body,docElem=document.documentElement,scrollTop=window.pageYOffset||docElem.scrollTop||body.scrollTop,scrollLeft=window.pageXOffset||docElem.scrollLeft||body.scrollLeft,clientTop=docElem.clientTop||body.clientTop||0,clientLeft=docElem.clientLeft||body.clientLeft||0,top=box.top+scrollTop-clientTop,left=box.left+scrollLeft-clientLeft;return{top:Math.round(top),left:Math.round(left)}}var text,Text=Darkroom.Transformation.extend({applyTransformation:function(canvas,image,next){var viewport=Darkroom.Utils.computeImageViewPort(image),imageWidth=viewport.width,imageHeight=viewport.height,texts=this.options.texts;for(var a in texts){var object=new fabric.Text(texts[a].text,texts[a]),left=object.additional.left*imageWidth,top=object.additional.top*imageHeight,width=object.additional.width*imageWidth,height=object.additional.height*imageHeight;object.setLeft(left),object.setTop(top),object.setScaleX(width/object.getWidth()),object.setScaleY(height/object.getHeight()),canvas.add(object)}var imageB64=canvas.toDataURL(),snapshot=new Image;snapshot.onload=function(){if(!(1>height||1>width)){var imgInstance=new fabric.Image(this,{selectable:!1,evented:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,hasControls:!1,hasBorders:!1}),width=this.width,height=this.height;canvas.setWidth(width),canvas.setHeight(height),image.remove(),canvas.add(imgInstance),next(imgInstance)}},snapshot.src=imageB64}}),hasInput=!1,input=null,active=!1,textIsActive=!1,itsMe=!1,colorInputForText=null,select=null;Darkroom.plugins.text=Darkroom.Plugin.extend({startX:null,startY:null,defaults:{fontSize:32,fontFamily:"Times New Roman",colorInputForText:"rgb(0,0,0)"},initialize:function(){var buttonGroup=this.darkroom.toolbar.createButtonGroup();this.textButton=buttonGroup.createButton({image:"text"}),this.textBoldButton=buttonGroup.createButton({image:"bold-text",hide:!0}),this.textItalicButton=buttonGroup.createButton({image:"italicize-text",hide:!0}),this.textUnderlinedButton=buttonGroup.createButton({image:"underline-text",hide:!0}),this.textColorButton=buttonGroup.createButton({image:"square",hide:!0}),this.textSizeButton=buttonGroup.createButton({image:"",hide:!0}),this.okButton=buttonGroup.createButton({image:"done",type:"success",hide:!0}),this.cancelButton=buttonGroup.createButton({image:"close",type:"danger",hide:!0}),this.textButton.addEventListener("click",this.toggleTexting.bind(this)),this.okButton.addEventListener("click",this.saveTexting.bind(this)),this.cancelButton.addEventListener("click",this.releaseFocus.bind(this)),this.textBoldButton.addEventListener("click",this.textBoldToggle.bind(this)),this.textItalicButton.addEventListener("click",this.textItalicToggle.bind(this)),this.textUnderlinedButton.addEventListener("click",this.textUnderlineToggle.bind(this)),this.textColorButton.addEventListener("click",this.textColorButtonClick.bind(this)),this.textSizeButton.addEventListener("click",this.textSizeButtonClick.bind(this)),this.darkroom.canvas.on("mouse:down",this.onMouseDown.bind(this)),this.darkroom.canvas.on("object:rotating",this.onObjectRotating.bind(this)),this.darkroom.addEventListener("core:transformation",this.releaseFocus.bind(this)),this.darkroom.addEventListener("button-group:activate",this.activateSomeToolbarButton.bind(this)),this.darkroom.addEventListener("button-group:save",this.saveTexting.bind(this)),this.setTextColorButtonColor(this.options.colorInputForText),this.setTextSizeButtonSize(this.options.fontSize)},activateSomeToolbarButton:function(){itsMe?itsMe=!1:this.releaseFocus()},setTextSizeButtonSize:function(number){for(var element=this.textSizeButton.element,i=0,nodes=element.childNodes;i<nodes.length;i++)element.removeChild(nodes[i]);element.appendChild(document.createTextNode(number))},onMouseDown:function(event){if(this.hasFocus()&&!textIsActive){var canvas=this.darkroom.canvas;canvas.calcOffset();var pointer=canvas.getPointer(event.e),x=pointer.x,y=pointer.y;canvas.discardActiveObject(),this.removeInput(),this.addInput(x,y)}},onObjectRotating:function(event){this.hasFocus()&&input&&this.removeInput()},toggleTexting:function(){this.hasFocus()?this.releaseFocus():this.requireFocus()},saveTexting:function(){if(this.hasFocus()){var image=this.darkroom.image,objectsOnCanvas=this.darkroom.canvas.getObjects(),texts=[];for(var i in objectsOnCanvas){var obj=objectsOnCanvas[i];if(obj.hasOwnProperty("text")){var writer=obj.toJSON(),top=writer.top-image.getTop(),left=writer.left-image.getLeft(),width=writer.width,height=writer.height;writer.additional={top:top/image.getHeight(),left:left/image.getWidth(),width:width/image.getWidth(),height:height/image.getHeight()},texts.push(writer)}}this.darkroom.applyTransformation(new Text({texts:texts}))}},hasFocus:function(){return active},requireFocus:function(){active=!0,this.darkroom.canvas.defaultCursor="crosshair",this.textButton.active(!0),this.okButton.hide(!1),this.cancelButton.hide(!1),this.textBoldButton.hide(!1),this.textItalicButton.hide(!1),this.textUnderlinedButton.hide(!1),this.textColorButton.hide(!1),this.textSizeButton.hide(!1),itsMe=!0,this.darkroom.dispatchEvent("button-group:activate")},releaseFocus:function(){active=!1,this.removeInput();for(var texts=this.darkroom.canvas.getObjects(),a=0;a<texts.length;a++){var i=texts[a];i.text&&(this.darkroom.canvas.remove(i),a--)}this.textButton.active(!1),this.okButton.hide(!0),this.cancelButton.hide(!0),this.textBoldButton.hide(!0),this.textItalicButton.hide(!0),this.textUnderlinedButton.hide(!0),this.textColorButton.hide(!0),this.textSizeButton.hide(!0),this.darkroom.canvas.defaultCursor="default"},textBoldToggle:function(){input&&("bold"===input.style.fontWeight?input.style.fontWeight="normal":input.style.fontWeight="bold",input.focus())},textItalicToggle:function(){input&&("italic"===input.style.fontStyle?input.style.fontStyle="normal":input.style.fontStyle="italic",input.focus())},textUnderlineToggle:function(){input&&("underline"===input.style.textDecoration?input.style.textDecoration="blink":input.style.textDecoration="underline",input.focus())},textColorButtonClick:function(){colorInputForText?colorInputForText.click():(colorInputForText=document.createElement("input"),colorInputForText.setAttribute("type","color"),colorInputForText.setAttribute("value","#ffffff"),colorInputForText.style.position="absolute",colorInputForText.style.left="-9999px",colorInputForText.style.top="0px",document.body.appendChild(colorInputForText),colorInputForText.oninput=function(e){this.setTextColor(e.target.value)}.bind(this),setTimeout(function(){colorInputForText.click()},500))},textSizeButtonClick:function(e){if(select)"none"===select.style.display?select.style.display="block":select.style.display="none";else{var textSize=[8,9,10,13,14,16,18,20,22,24,28,32,36,40,46,52,58,64,72],element=this.textSizeButton.element,elementPosition=getOffset(this.textSizeButton.element),self=this;select=document.createElement("select");for(var i=0;i<textSize.length;i++){var option=document.createElement("option");option.setAttribute("value",textSize[i].toString());var text=document.createTextNode(textSize[i].toString());option.appendChild(text),select.appendChild(option)}select.style.display="block",select.style.position="absolute",select.style.left=elementPosition.left+"px",select.style.top=elementPosition.top+element.offsetHeight+"px",select.style.zIndex=99999999,select.value=this.options.fontSize,select.onchange=function(){self.setTextSizeButtonSize(select.value),select.style.display="none",self.options.fontSize=select.value,input&&(input.style.fontSize=select.value+"px")},document.body.appendChild(select)}},setTextColor:function(color){this.setTextColorButtonColor(color),input&&(input.style.color=color,input.focus())},setTextColorButtonColor:function(color){this.textColorButton.element.getElementsByTagName("svg")[0].style.fill=color},getTextColorButtonColor:function(){return this.textColorButton.element.getElementsByTagName("svg")[0].style.fill},addInput:function(x,y,text,object){var containerOfCanvas=document.getElementsByTagName("canvas")[0].parentElement;input=document.createElement("input"),input.type="text",input.style.position="absolute",input.style.left=x+"px",input.style.top=y+"px",input.className="darkroom-input",input.style.fontSize=this.options.fontSize+"px",input.style.fontFamily=this.options.fontFamily,input.style.color=this.getTextColorButtonColor(),object&&(input.value=object.getText(),object.setText(""),input.style.fontStyle=object.getFontStyle(),input.style.fontWeight=object.getFontWeight(),input.style.textDecoration=object.getTextDecoration());var self=this;input.onkeydown=function(e){var keyCode=e.keyCode;if(13===keyCode){var style=window.getComputedStyle(this),options={fontSize:style.fontSize,fontStyle:style.fontStyle,fontWeight:style.fontWeight,textDecoration:style.textDecoration,color:style.color};self.renderTextOnVisibleCanvas(this.value,parseInt(style.left,10)+parseInt(style.paddingLeft)+parseInt(style.borderLeftWidth)+parseInt(style.marginLeft),parseInt(style.top,10)+parseInt(style.paddingTop)+parseInt(style.borderTopWidth)+parseInt(style.marginTop)+1,options,object),containerOfCanvas.removeChild(input),hasInput=!1}},containerOfCanvas.appendChild(input),input.focus(),hasInput=!0},removeInput:function(){if(input){var containerOfCanvas=document.getElementsByTagName("canvas")[0].parentElement;isDescendant(containerOfCanvas,input)?containerOfCanvas.removeChild(input):null}},renderTextOnVisibleCanvas:function(txt,x,y,options,object){if(object)object.setText(txt),object.setOptions({fontSize:parseInt(options.fontSize,10),fontWeight:options.fontWeight,fontStyle:options.fontStyle,textDecoration:options.textDecoration,fill:options.color}),this.darkroom.canvas.renderAll();else{text=new fabric.Text(txt,{fontSize:this.options.fontSize,fontFamily:this.options.fontFamily,left:x,top:y,fontWeight:options.fontWeight,fontStyle:options.fontStyle,textDecoration:options.textDecoration,fill:options.color,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0}),text.on("mouseover",function(e){textIsActive=!0}),text.on("mouseout",function(e){textIsActive=!1});var self=this;text.on("mousedown",function(e){self.removeInput(),"undefined"!=typeof this.timeout&&(new Date).getTime()-this.timeout<500&&self.addInput(this.getLeft(),this.getTop(),this.getText(),this),this.timeout=(new Date).getTime()}),this.darkroom.canvas.add(text)}}})}(),function(){function getOffset(elem){return elem.getBoundingClientRect?getOffsetRect(elem):getOffsetSum(elem)}function getOffsetSum(elem){for(var top=0,left=0;elem;)top+=parseInt(elem.offsetTop),left+=parseInt(elem.offsetLeft),elem=elem.offsetParent;return{top:top,left:left}}function getOffsetRect(elem){var box=elem.getBoundingClientRect(),body=document.body,docElem=document.documentElement,scrollTop=window.pageYOffset||docElem.scrollTop||body.scrollTop,scrollLeft=window.pageXOffset||docElem.scrollLeft||body.scrollLeft,clientTop=docElem.clientTop||body.clientTop||0,clientLeft=docElem.clientLeft||body.clientLeft||0,top=box.top+scrollTop-clientTop,left=box.left+scrollLeft-clientLeft;return{top:Math.round(top),left:Math.round(left)}}var Path=Darkroom.Transformation.extend({applyTransformation:function(canvas,image,next){var viewport=Darkroom.Utils.computeImageViewPort(image),imageWidth=viewport.width,imageHeight=viewport.height,paths=this.options.paths;for(var a in paths){var object=new fabric.Path(paths[a].path.join(""),paths[a]),left=object.additional.left*imageWidth,top=object.additional.top*imageHeight,width=object.additional.width*imageWidth,height=object.additional.height*imageHeight;object.setLeft(left),object.setTop(top),object.setScaleX(width/object.getWidth()),object.setScaleY(height/object.getHeight()),canvas.add(object)}var imageB64=canvas.toDataURL(),snapshot=new Image;snapshot.onload=function(){if(!(1>height||1>width)){var imgInstance=new fabric.Image(this,{selectable:!1,evented:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,hasControls:!1,hasBorders:!1}),width=this.width,height=this.height;canvas.setWidth(width),canvas.setHeight(height),image.remove(),canvas.add(imgInstance),next(imgInstance)}},snapshot.src=imageB64}}),active=!1,itsMe=!1,colorInputForPaint=null,select=null;Darkroom.plugins.paint=Darkroom.Plugin.extend({startX:null,startY:null,defaults:{brushSize:10,colorInputForPaint:"rgb(0,0,0)"},initialize:function(){var buttonGroup=this.darkroom.toolbar.createButtonGroup();this.paintButton=buttonGroup.createButton({image:"brush"}),this.paintColorButton=buttonGroup.createButton({image:"square",hide:!0}),this.paintSizeBrush=buttonGroup.createButton({image:"",hide:!0}),this.okButton=buttonGroup.createButton({image:"done",type:"success",hide:!0}),this.cancelButton=buttonGroup.createButton({image:"close",type:"danger",hide:!0}),this.paintButton.addEventListener("click",this.togglePainting.bind(this)),this.okButton.addEventListener("click",this.savePainting.bind(this)),this.cancelButton.addEventListener("click",this.releaseFocus.bind(this)),this.paintColorButton.addEventListener("click",this.paintColorButtonClick.bind(this)),this.paintSizeBrush.addEventListener("click",this.paintSizeButtonClick.bind(this)),this.darkroom.addEventListener("core:transformation",this.releaseFocus.bind(this)),this.darkroom.addEventListener("button-group:activate",this.activateSomeToolbarButton.bind(this)),this.darkroom.canvas.freeDrawingCursor="crosshair",this.setBrushSizeButtonSize(this.options.brushSize),this.setPaintColorButtonColor(this.options.colorInputForPaint),this.darkroom.canvas.freeDrawingBrush.color=this.options.colorInputForPaint,this.darkroom.canvas.freeDrawingBrush.width=this.options.brushSize},activateSomeToolbarButton:function(){itsMe?itsMe=!1:this.releaseFocus()},setBrushSizeButtonSize:function(number){for(var element=this.paintSizeBrush.element,i=0,nodes=element.childNodes;i<nodes.length;i++)element.removeChild(nodes[i]);element.appendChild(document.createTextNode(number))},paintColorButtonClick:function(){colorInputForPaint?colorInputForPaint.click():(colorInputForPaint=document.createElement("input"),colorInputForPaint.setAttribute("type","color"),colorInputForPaint.setAttribute("value","#ffffff"),colorInputForPaint.style.position="absolute",colorInputForPaint.style.left="-9999px",colorInputForPaint.style.top="0px",document.body.appendChild(colorInputForPaint),colorInputForPaint.oninput=function(e){this.setPaintColor(e.target.value)}.bind(this),setTimeout(function(){colorInputForPaint.click()},500))},setPaintColor:function(color){this.setPaintColorButtonColor(color),this.darkroom.canvas.freeDrawingBrush.color=color},setPaintColorButtonColor:function(color){this.paintColorButton.element.getElementsByTagName("svg")[0].style.fill=color},togglePainting:function(){this.hasFocus()?this.releaseFocus():this.requireFocus()},savePainting:function(){if(this.hasFocus()){var image=this.darkroom.image,objectsOnCanvas=this.darkroom.canvas.getObjects(),paths=[];for(var i in objectsOnCanvas){var obj=objectsOnCanvas[i];if(obj.hasOwnProperty("path")){var writer=obj.toJSON(),top=writer.top-image.getTop(),left=writer.left-image.getLeft(),width=writer.width,height=writer.height;writer.additional={top:top/image.getHeight(),left:left/image.getWidth(),width:width/image.getWidth(),height:height/image.getHeight()},paths.push(writer)}}this.darkroom.applyTransformation(new Path({paths:paths}))}},hasFocus:function(){return active},requireFocus:function(){active=!0,this.darkroom.canvas.defaultCursor="crosshair",this.paintButton.active(!0),this.okButton.hide(!1),this.cancelButton.hide(!1),this.paintColorButton.hide(!1),this.paintSizeBrush.hide(!1),this.darkroom.canvas.isDrawingMode=!0,itsMe=!0,this.darkroom.dispatchEvent("button-group:activate")},releaseFocus:function(){active=!1;for(var paths=this.darkroom.canvas.getObjects(),a=0;a<paths.length;a++){var i=paths[a];i.path&&(this.darkroom.canvas.remove(i),a--)}this.paintButton.active(!1),this.okButton.hide(!0),this.cancelButton.hide(!0),this.paintColorButton.hide(!0),this.paintSizeBrush.hide(!0),this.darkroom.canvas.isDrawingMode=!1},paintSizeButtonClick:function(e){if(select)"none"===select.style.display?select.style.display="block":select.style.display="none";else{for(var brushSize=[],i=1;26>i;i++)brushSize.push(i);var element=this.paintSizeBrush.element,elementPosition=getOffset(this.paintSizeBrush.element),self=this;select=document.createElement("select");for(var i=0;i<brushSize.length;i++){var option=document.createElement("option");option.setAttribute("value",brushSize[i].toString());var text=document.createTextNode(brushSize[i].toString());option.appendChild(text),select.appendChild(option)}select.style.display="block",select.style.position="absolute",select.style.left=elementPosition.left+"px",select.style.top=elementPosition.top+element.offsetHeight+"px",select.style.zIndex=99999999,select.value=this.darkroom.canvas.freeDrawingBrush.width,select.onchange=function(){self.setBrushSizeButtonSize(select.value),select.style.display="none",self.darkroom.canvas.freeDrawingBrush.width=select.value},document.body.appendChild(select)}}})}();